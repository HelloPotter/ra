<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PTE Speaking Practice — PSP 1.96</title>

<!-- ResponsiveVoice TTS -->
<script src="https://code.responsivevoice.org/responsivevoice.js"></script>

<style>
:root{
  --bg:#f4f6fb;
  --panel:#ffffff;
  --accent:#1f6feb;
  --accent-dark:#155fcc;
  --highlight:#d32f2f;
  --muted:#6b7280;
  --gap:10px; /* top controls gap requirement */
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;color:#0b1220;}
.wrap{max-width:920px;margin:20px auto;padding:18px;}
header{text-align:center;margin-bottom:12px;}
h1{margin:0;font-size:32px;}
.sub{color:var(--muted);margin-top:6px;font-size:14px;}

/* Top controls row - aligns with .wrap width */
.controls{
  display:flex;
  gap:var(--gap);          /* uniform 10px gap between the 6 controls */
  align-items:flex-end;
  width:100%;
  margin-bottom:12px;
  background:var(--panel);
  padding:10px;
  border-radius:8px;
  box-shadow:0 4px 14px rgba(0,0,0,0.04);
}

/* each control column: label above input */
.ctrl{display:flex;flex-direction:column;gap:6px;min-width:0;}
.ctrl label{font-size:13px;color:var(--muted);}

/* unified control heights */
.ctrl select, .ctrl input[type="number"], .ctrl button {
  height:34px;
  padding:6px 8px;
  border-radius:6px;
  border:1px solid #d7dbe4;
  background:#fff;
  font-size:14px;
  appearance:none;
}

/* Button visual */
.btn { cursor:pointer; border:none; border-radius:6px; height:34px; padding:6px 8px; font-size:14px; }
.small-btn { background:#fff; color:#0b1220; border:1px solid #d7dbe4; }
.primary-btn { background:var(--accent); color:#fff; }

/* Fixed widths (Question flexible) */
.ctrl.section { width:125px; flex:0 0 125px; }
.ctrl.question{ flex:1 1 auto; min-width:220px; } /* Question is flexible */
.ctrl.voice { width:140px; flex:0 0 140px; }
.ctrl.repeat { width:50px; flex:0 0 50px; } /* a little wider for number input + arrows */
.ctrl.mode { width:110px; flex:0 0 110px; }
.ctrl.view { width:140px; flex:0 0 140px; }

/* Text panel - left aligned, avoid breaking words mid-character */
.text-panel{
  background:var(--panel);
  padding:22px;
  border-radius:8px;
  box-shadow:0 4px 14px rgba(0,0,0,0.04);
  font-size:32px;
  line-height:1.9;
  min-height:240px;
  margin-bottom:14px;
  text-align:left; /* left align */
  word-break: normal;       /* don't break words in the middle */
  overflow-wrap:break-word; /* allow breaking at word boundaries */
  white-space:normal;
}

/* Word wrapper prevents breaking inside the word (keeps characters together) */
.word { display:inline-block; white-space:nowrap; }

/* 字符级高亮：使用 inline（而非 inline-block）避免字符间被浏览器当成换行点 */
.char{
  display:inline;                   /* 关键：inline 可避免单词中间换行 */
  white-space:pre;                   /* 保留空格/空白的显示一致性（但空格仍需由 text nodes 提供） */
  transition: color 0.04s linear;
  color:#111;
}
.char.colored{ color: var(--highlight); }

/* Buttons below */
.controls-row { display:flex; gap:10px; justify-content:center; margin-bottom:10px; }
button.big {
  width:140px; height:44px; border-radius:6px; font-size:16px; cursor:pointer; border:none;
}
button.big.primary { background:var(--accent); color:#fff; }
button.big.secondary { background:#fff; border:1px solid #d7dbe4; color:#0b1220; }

/* Footer */
.footer { text-align:center; color:var(--muted); margin-top:28px; font-size:13px; }

/* Small responsive tweaks */
@media (max-width:760px){
  .controls{ gap:8px; overflow-x:auto; padding-bottom:12px; }
  .ctrl.voice{flex:0 0 150px;}
  .ctrl.view{flex:0 0 120px;}
}
#paraMeta {
  font-size: 18px;     /* 调整字号，例如原内容为约20px，可改成18px或更小 */
  color: var(--muted); /* 保持灰色风格 */
  margin-bottom: 10px; /* 保持与正文的距离 */
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>PTE Speaking Practice</h1>
    <div class="sub">Practice Read Aloud & Repeat Sentence — Designed for PTE Core</div>
  </header>

  <!-- Top controls -->
  <div class="controls" role="region" aria-label="Top controls">
    <div class="ctrl section">
      <label for="selectSection">Section</label>
      <select id="selectSection" aria-label="Section select">
        <option value="RA">Read Aloud</option>
        <option value="RS">Repeat Sentence</option>
      </select>
    </div>

    <div class="ctrl question">
      <label for="selectQ">Question</label>
      <select id="selectQ" aria-label="Question select"><option value="">(choose a question)</option></select>
    </div>

    <div class="ctrl voice">
      <label for="voiceSelect">Voice</label>
      <select id="voiceSelect" aria-label="Voice select">
        <option>US English Male</option>
        <option>US English Female</option>
        <option>UK English Male</option>
        <option>UK English Female</option>
      </select>
    </div>

    <div class="ctrl repeat">
      <label for="repeatInput">Repeat</label>
      <input id="repeatInput" type="number" min="1" max="10" value="1" aria-label="Repeat times">
    </div>

    <div class="ctrl mode">
      <label for="modeBtn">Mode</label>
      <button id="modeBtn" class="btn small-btn" aria-pressed="false">Custom Mode</button>
    </div>

    <div class="ctrl view">
      <label for="fullscreenBtn">View</label>
      <button id="fullscreenBtn" class="btn small-btn">Enter Full Screen</button>
    </div>
  </div>

  <!-- Text panel -->
  <div id="textPanel" class="text-panel" aria-live="polite">
    <div id="paraMeta" style="color:var(--muted); margin-bottom:8px;">Select a question to begin</div>
    <div id="paraContent">—</div>
  </div>

  <!-- playback controls -->
  <div class="controls-row">
    <button id="prevBtn" class="big secondary">◀ Previous</button>
    <button id="startBtn" class="big primary">▶ Start</button>
    <button id="nextBtn" class="big secondary">Next ▶</button>
  </div>

  <div id="status" style="text-align:center;color:var(--muted);font-size:14px;margin-bottom:8px;">Status: idle</div>

  <div class="footer">PTE Speaking Practice 1.96 — © 2025 Stone Zhao</div>
</div>

<script>
/* ========== PSP 1.95 - RA & RS data (full) ========== */
const raPassages = [
  { id:4, title:"Yellow", text:
  `Yellow is considered as the most optimistic color. Yet surprisingly, people lose their tempers more often in yellow rooms / and babies cry more in them. The reason may be that yellow is the hardest color / for eyes to take in. So it can be overpowering if overused.`},
  { id:10, title:"Alphabet", text:
  `The problem begins with the alphabet itself. Building a spelling system for English / using letters that come from Latin — despite the two languages not sharing exactly the same set of sounds — is like building a playroom / using an IKEA office set.`},
  { id:17, title:"Cat's Paws", text:
  `In the photo, the wild cat's huge paws are clamped / onto the side of the white safari Jeep / in which Chappell was a passenger. Almost as tall as the Jeep on her hind legs, she appears to be forcing her muzzle / into the back window.`},
  { id:26, title:"Yellow", text:
  `Cheerful sunny yellow is an attention getter. While it is considered an optimistic color, people lose their tempers more often in yellow rooms, and babies will cry more. It is the most difficult color / for the eye to take in, so it can be overpowering if overused. Yellow enhances concentration, hence its use for legal pads. It also speeds metabolism.`},
  { id:32, title:"War on Women", text:
  `While the Republican field is packed with male candidates, so far, some of the sharpest Clinton critics have come from women. Democrats successfully campaigned on an alleged GOP perpetrated "war on women" in 2012, but faltered in 2014 / when they tried the same tactic. With Hillary Clinton as the likely Democratic nominee, the fight for women voters will be a central part / of the 2016 campaign.`},
  { id:51, title:"Classic Adaption", text:
  `A recent trend in the entertainment world is to adapt classic works of literature / for either TV or movies. One argument is that this is to everyone's benefit, as it introduces people to works / they might otherwise never have, but is rarely done successfully.`},
  { id:67, title:"Market Research", text:
  `Market research is a vital part / of the planning of any business. However experienced you or your staff may be in a particular field, if you are thinking of introducing a service to new area, it is important to find out / what the local population thinks about it first.`},
  { id:110, title:"Learning Method", text:
  `There is no single method of learning / that guarantees success. How we learn that depends on many different factors. And what works best for you / will not necessarily be the same as the approach used for the other students / even they study the same course. We are all unique as learners, although some patterns emerge from any groups of students.`},
  { id:117, title:"Rural Population", text:
  `Thus, a country might possess a sizeable rural population, but have an economic system / in which the interests of the voters were predominantly related to their incomes, not to their occupations or location; and in such a country the political system would be unlikely / to include an important agrarian party.`},
  { id:136, title:"Productive Capacity", text:
  `The core of the problem was the immense disparity / between the country’s productive capacity / and the ability of people to consume. Great innovations in productive techniques during and after the war raised the output of industry / beyond the purchasing capacity of U.S. farmers / and wage earners.`},
  { id:145, title:"Population Growth", text:
  `How quickly is the world's population growing? In the United States and other developed countries, the current growth rate is very low. In most developing countries, the human population is growing at a rate / of nearly 3 people per second. Because of this bustling growth rate, the human population is well on its way / to reaching 9 billion within lifetime.`},
  { id:250, title:"Girls v.s. Boys", text:
  `Teenage girls are continuing to outperform boys in English / while the gender gap in achievements in math and science has almost disappeared. The figures show that last year 80% of 14-year-old girls reached at least the expected level 5 in English, compared with 65% of boys. But in math, the girls are just 1% ahead of boys, while in science the difference is 2%.`},
  { id:252, title:"Difficult Conversations", text:
  `Surprisingly, despite what appear to be infinite variations, all difficult conversations share a common structure. When you’re caught up in the details and anxiety / of a particularly difficult conversation, this structure is hard to see. But understanding that structure is essential / to improve how you handle your most challenging conversations.`},
  { id:269, title:"Language Appearance", text:
  `It seems that language appeared from nowhere / since no other species has anything resembling human language. However, other animals do possess basic systems / for perceiving and producing sounds / that enable them to communicate. These systems may have been in place / before the appearance of language.`},
  { id:288, title:"Fast Food", text:
  `Hundreds of millions of American people eat fast food every day / without giving it too much thought, unaware of the subtle and not so subtle ramifications / of their purchases. They just grab their tray off the counter, find a table, take a seat, unwrap the paper, and dig in. The whole experience is transitory / and soon forgotten.`},
  { id:302, title:"Elephant", text:
  `The elephant is the largest living land mammal. During evolution, its skeleton has greatly altered from the usual mammal, designed for two main reasons. One is to cope with the great weight of huge grinding cheek teeth / and elongated tusk, making the skull particularly massive. The other is to support the enormous bulk / of such a huge body.`},
  { id:316, title:"Only Family", text:
  `Imagine living all your life / as the only family on your street. Then, one morning, you open the front door / and discover houses all around you. You see neighbors tending their gardens / and children walking to school. Where did all the people come from? What if the answer turned out to be / that they had always been there — you just hadn't seen them.`},
  { id:326, title:"Father (B)", text:
  `Every morning, no matter how late he had been up, my father rose at 5:30, went to his study, wrote for a couple of hours, made us all breakfast, read the paper with my mother, and then went back to work for the rest of the morning. Many years passed before I realized / that he did this by choice, for a living, and that he was not unemployed or mentally ill.`},
  { id:338, title:"Parent Teacher Conferences", text:
  `Schools host parent teacher conferences four times a year / and it is important for families to attend. This is your chance to meet with teachers / and ask questions about your child's progress. It can be helpful to write down questions / ahead of time.`},
  { id:375, title:"Microscopic Invader", text:
  `We all know about bacteria, viruses / and microscopic protozoa. We can watch the way / that these tiny agents move into our bodies / and damage our organs. We have a growing understanding / of how our body mounts defensive strategies / that fight off these invaders, and have built some clever chemical / that can help mount an assault on these bio-villains.`},
  { id:376, title:"Market Research", text:
  `There are two main types of market research. Quantitative research involves collecting a lot of information / by using techniques such as questionnaires / and other forms of survey. Qualitative research involves working with smaller samples of consumers, often asking them to discuss products and services / while researchers take notes about what they have to say.`},
  { id:463, title:"Source of Funding", text:
  `A study found that the research funded by the soft drinks industry / had different results from research funded by other sources / and went on to suggest that they may have been biased / by the research itself. The whole point of the scientific methods / is to ensure the research results are not influenced / by the source of funding.`},
  { id:472, title:"Selective History", text:
  `History is selective. What history books tell us about the past / is not everything that happened, but what historians have selected. They cannot put in everything: choices have to be made. Choices must similarly be made / about which aspects of the past should be formally taught / to the next generation / in the shape of school history lessons.`},
  { id:498, title:"Bond Funds", text:
  `Most bond funds have credit risk, which is the risk that companies or other issuers whose bonds are owned by the fund / may fail to pay their debts, including the debt owed to the holder of their bonds. Some funds have little credit risk, such as those that invest in insured bonds / or U.S. Treasury bonds. But be careful: nearly all bond funds have interest rate risk, which means that the market value of the bonds they hold / will go down when interest rates go up.`},
  { id:541, title:"Liverpool", text:
  `Located at the heart of two world famous cities, Liverpool and London, Liverpool’s excellence in teaching, learning and research, first-class facilities / and outstanding support places the university in the top 1% of universities worldwide. The University of Liverpool will provide you with an inspiring student experience, / in a diverse international community.`},
  { id:577, title:"Conscientiousness", text:
  `Conscientiousness is a fundamental personality trait. A conscientious person is good at self-regulation / and impulse control. This trait influences whether you will set and keep long-range goals, deliberate over choices, behave cautiously or impulsively, / and take obligations to others seriously.`},
  { id:579, title:"Blue Whale", text:
  `Blue whales are the largest living mammals. Though reports of maximum length and weight vary from one account to another, Antarctic blue whales are known to have reached lengths / to 100 feet / and weights of over 150 tons / before stocks were severely depleted by whaling operations. North Atlantic blue whales may be expected to reach lengths / of 80–85 feet.`},
  { id:584, title:"Canada", text:
  `With a population of only just over 30 million / living in the world's second largest country, Canada is justly renowned / for vast tracts of wilderness / untroubled by pollution either from industry / or from intensive farming methods. A major conservation issue is the battle / to stop the logging of virgin forest / in northern Ontario / and on the west coast.`},
  { id:590, title:"Children Helping Others", text:
  `Children as young as 14 months old / will spontaneously help others / for no reward. But a study of 3-to-5-year-olds found that, although they would spontaneously draw pictures, if they were given a reward for drawing pictures, then later they wouldn’t make any drawings / unless a reward was offered.`},
  { id:591, title:"Charlie Parker", text:
  `Charlie Parker noticed that the solos were only improvised through the melodies, but that he could also improvise them through the chords, thus creating new variations over the structure of the songs, and also playing more notes / and faster.`},
  { id:710, title:"Antarctic", text:
  `The world's fifth largest continent: Antarctica is almost entirely covered by ice / 2000 meters thick. The area sustains varied wildlife / including seals, whales, and penguins. The Antarctic treaty signed in 1959 / and enforced since 1961 / provides for international governance of Antarctica.`},
  { id:744, title:"Voyage", text:
  `A crew of scientists voyaged by ship / from the southern tip of Chile / into the frigid Antarctic / to search for clues to one of the great unknowns of climate change. They planned to crisscross a remote patch of sea / near the spot where, a year earlier, another crew had injected a tankful of an inert chemical / one mile below the surface.`},
  { id:783, title:"Noise Restrictions", text:
  `The noise restrictions are based on measurements on animals in captivity / exposed to noise levels / that induce a temporary threshold shift (TTS) in hearing. The TTS onset threshold is the lowest noise exposure / capable of inducing a small temporary reduction of hearing sensitivity, also known as auditory fatigue, with full recovery shortly after exposure.`},
  { id:787, title:"Depression Symptoms", text:
  `Symptoms of depression decrease / with improvements in sense of smell, particularly among patients with dysosmia. New research published in the journal Scientific Reports highlights the intricate relationship / between depression / and sense of smell. The study found that participants’ symptoms of depression dropped / as their odor identification improved, particularly among those with an impaired sense of smell.`},
  { id:808, title:"Gut Microbiome", text:
  `Research has shown that the gut microbiome is important / for human physiology and health. Disturbances to the composition of the gut microbiome / can be associated with chronic diseases / such as gastrointestinal inflammatory disorders, neurological, cardiovascular / and respiratory illnesses. The human body has evolved strategies / to ensure that a symbiotic relationship exists / between the microbes in our gut / and our cells.`},
  { id:1012, title:"Making Notes", text:
  `The whole purpose of making notes / is to aid your learning. It is important to go back over them / within a day of making them / to make sure they make sense / and make them legible for future revisions. Also, going back over them should highlight the key questions / of areas in which you want to do further reading.`},
  { id:1022, title:"Enough Fluid", text:
  `Your body is nearly two-thirds water. And so it is really important / that you consume enough fluid / to stay hydrated / and healthy. If you don't get enough fluid you may feel tired, get headaches, and not perform at your best.`},
  { id:1025, title:"Rates of Depression", text:
  `At a time when stress levels are soaring, rates of depression are increasing / and the gap between rich and poor is ever widening. We believe that giving can play a positive role / in helping people to feel connected to those around them and generate a sense of purpose / and hope. When we give, we feel valued, useful / and happy.`},
  { id:1034, title:"Bill", text:
  `The bill calls for the establishment of the National Landslide Hazards Reduction Program / within one year of becoming law. The program serves numerous functions, including to identify and understand landslide hazards and risks, reduce losses from landslides, protect communities at risk of landslides hazards, and improve communication and emergency preparedness.`},
  { id:1228, title:"Community Gardens", text:
  `Around the world, city residents build gardens / on balconies, rooftops / and small strips of land. A March 2023 study published in the journal Ecology Letters confirms that beyond offering food / and an outlet for cultivating outdoor space, urban gardens provide benefits for the humans, insects, and animals / who inhabit these leafy respites / from city life.`},
  { id:1289, title:"Credit Cards", text:
  `Credit Cards are a ubiquitous form of payment / that have revolutionized the way we conduct transactions. With a credit card, individuals can make purchases / without having to carry cash / or worry about the availability of funds. Credit cards also offer a range of benefits / such as cashback rewards, travel points, and purchase protection.`}
];

const rsPassages = [
{"id": 1, "title": "Boarding pass", "text": "You need to prepare your boarding pass and passport in front of the gate."},
{"id": 2, "title": "Passport at gate", "text": "You need to prepare your boarding pass and passport at the gate."},
{"id": 3, "title": "Supermarket near theater", "text": "The supermarket is located near the theater."},
{"id": 4, "title": "Art museum", "text": "The art museum is located across the street and near the theater."},
{"id": 5, "title": "Written exam", "text": "You need to pass the written exam to get the driver's licenses."},
{"id": 6, "title": "Applying for license", "text": "You need to pass the written exam before applying for the driver's license."},
{"id": 7, "title": "New photo", "text": "You need to get a new photo for your driver's license."},
{"id": 8, "title": "Warm clothes", "text": "You need to have warm clothes for winter."},
{"id": 9, "title": "Bus for London", "text": "The bus for London will leave ten minutes later than planned."},
{"id": 10, "title": "Leave early", "text": "The bus for London will leave early tomorrow morning."},
{"id": 11, "title": "Bus in front", "text": "The bus right out in the front will take you to the station."},
{"id": 12, "title": "Bus by building", "text": "The bus by the building goes directly to the central bus station."},
{"id": 13, "title": "Student card discount", "text": "If you show your student card, you will get a discount."},
{"id": 14, "title": "Attend every class", "text": "If you wish to be a good student, you should attend every class."},
{"id": 15, "title": "Forget password", "text": "If you forget your password, you need to contact the student center."},
{"id": 16, "title": "Leave a message", "text": "If I am out, please leave a message for my doctor."},
{"id": 17, "title": "Like cooking", "text": "If you like cooking, we can make supper together."},
{"id": 18, "title": "Text me", "text": "If you have my phone number, please text me about questions."},
{"id": 19, "title": "Author's point", "text": "I didn't understand the author's point of view on immigration."},
{"id": 20, "title": "Last sentence", "text": "I still don't understand the last sentence."},
{"id": 21, "title": "Different backgrounds", "text": "Students from different backgrounds can achieve a variety of qualifications."},
{"id": 22, "title": "Wide range", "text": "Students with a wide range of backgrounds can achieve a variety of qualifications."},
{"id": 23, "title": "Variety of qualifications", "text": "Students with a wide range of backgrounds will achieve a variety of qualifications."},
{"id": 24, "title": "Introduction sentences", "text": "In your introduction, show you understand the question in no more than four sentences."},
{"id": 25, "title": "Safety courses", "text": "The student must attend the safety courses and wear protective goggles before entering the laboratory."},
{"id": 26, "title": "Chemistry building", "text": "The chemistry building is located near the entrance to the campus."},
{"id": 27, "title": "Population growth", "text": "The graph shows the population growth in the last century."},
{"id": 28, "title": "Undergraduate programs", "text": "The full list of undergraduate programs can be found on the website."},
{"id": 29, "title": "Programs on website", "text": "The full list of undergraduate and postgraduate programs can be found on the website."},
{"id": 30, "title": "Meeting information", "text": "The information you need for this meeting is on the website."},
{"id": 31, "title": "Different religions", "text": "There are many different religions across the world."},
{"id": 32, "title": "Plagiarism approaches", "text": "There are various approaches for plagiarism across different university departments."},
{"id": 33, "title": "Origin of psychology", "text": "The origin of psychology can be traced back to ancient Greece."},
{"id": 34, "title": "Need for research", "text": "The study demonstrates a need for further research in this field."},
{"id": 35, "title": "Get through it", "text": "Try to get through it as soon as possible."},
{"id": 36, "title": "Running in partnership", "text": "This program is running in partnership with a number of departments."},
{"id": 37, "title": "Abstract evidence", "text": "Your abstract should contain the empirical evidence of your research."},
{"id": 38, "title": "Haven't done work", "text": "I haven't done a lot of work in this area."},
{"id": 39, "title": "Doctor appointment", "text": "I wasn't able to attend the tutorial because I had a doctor appointment."},
{"id": 40, "title": "Change classroom", "text": "We will change the classroom because this one is too small."},
{"id": 41, "title": "Assemble in hall", "text": "The students are supposed to assemble in the seminar hall before the announcement."},
{"id": 42, "title": "Skip sessions", "text": "You are not sure that you can skip the sessions for Wednesday."},
{"id": 43, "title": "Access to services", "text": "We often ask our students to get access to all sorts of services."},
{"id": 44, "title": "Car park permit", "text": "Car park permit can be obtained at the student service center."},
{"id": 45, "title": "Old building used", "text": "The old building in the university is still being used."},
{"id": 46, "title": "Depend on future", "text": "All students depend on their future."},
{"id": 47, "title": "Professor called", "text": "Professor Gordon just called me a few minutes ago."},
{"id": 48, "title": "Discuss education", "text": "We can discuss education in the tutorial next week."},
{"id": 49, "title": "Children need activities", "text": "Young children need education and organized activities."},
{"id": 50, "title": "Read sections", "text": "Please read the first two sections before next week."},
{"id": 51, "title": "Take their seats", "text": "Passengers on the train should take their seats."},
{"id": 52, "title": "Feet on seats", "text": "Passengers mustn't put their feet on the seats."},
{"id": 53, "title": "Not allowed", "text": "Passengers are not allowed to put their feet on the seats."},
{"id": 54, "title": "Should not put feet", "text": "Passengers should not put their feet on the seats."},
{"id": 55, "title": "Energy from food", "text": "The energy that we absorb from food can help us prevent the cold and become warmer."},
{"id": 56, "title": "Recruiting best students", "text": "We are committed to recruiting the best students regardless of their financial situation."},
{"id": 57, "title": "Attracting best students", "text": "We are committed to attracting the best students regardless of their financial circumstances."},
{"id": 58, "title": "Attract very good", "text": "We want to attract very good students regardless of their financial circumstances."},
{"id": 59, "title":"Son has cold","text":"Your son has a bad cold and is in the nurse's room."},
{"id":60,"title":"Bus arrive soon","text":"The bus for the airport will arrive soon."},
{"id":61,"title":"Bus will be there","text":"The bus for the airport will be there soon."},
{"id":62,"title":"Bring keys","text":"Always bring keys with you because the front door closes automatically."},
{"id":63,"title":"Keep the keys","text":"Please keep the keys with you because the front door often locks automatically."},
{"id":64,"title":"Wait a minute","text":"Just wait a minute, I will be with you shortly."},
{"id":65,"title":"Share their lunch","text":"Students have the opportunity to share their lunch during the common lunch break around noon."},
{"id":66,"title":"Prepare a report","text":"I make sure to prepare a report for the manager."},
{"id":67,"title":"Report for my boss","text":"I make sure to prepare a report for my boss."},
{"id":68,"title":"Have to prepare","text":"I have to prepare a report for the manager."},
{"id":69,"title":"Complete the task","text":"My Boss asked me to complete the task before Monday."},
{"id":70,"title":"Applied for position","text":"Some people have applied for the manager position."},
{"id":71,"title":"Manager meeting","text":"The manager will have a meeting in this room today."},
{"id":72,"title":"Wear a hard hat","text":"You must wear a hard hat when you go to the construction site."},
{"id":73,"title":"Make an appointment","text":"You must make an appointment to see the doctor."},
{"id":74,"title":"Grocery store","text":"The grocery store is around the corner down the street."},
{"id":75,"title":"Library closed","text":"The Library will be closed except during holidays."},
{"id":76,"title":"Early for interview","text":"I have to get up early for an interview tomorrow."},
{"id":77,"title":"Complete the project","text":"The students will complete the project by September."},
{"id":78,"title":"Speak to students","text":"You can speak to the current students at the information sessions."},
{"id":79,"title":"Record every detail","text":"You need to record every detail of the call in the afternoon."},
{"id":80,"title":"Remember every detail","text":"You should remember every detail of the call this afternoon."},
{"id":81,"title":"Detail of this call","text":"You should remember every detail of this call this afternoon."},
{"id":82,"title":"Enrollment requirements","text":"You have an enrollment full of requirements."},
{"id":83,"title":"Fix the problem","text":"I need somebody to fix the problem with the computer screen."},
{"id":84,"title":"Assignment words","text":"I would like my assignment to be less than 2,000 words."},
{"id":85,"title":"Wages on Thursday","text":"Your wages will be put into your bank account on Thursday."},
{"id":86,"title":"Wages on Tuesday","text":"Your wages will be put into your bank account on Tuesday."},
{"id":87,"title":"Vehicle collided","text":"The vehicle he traveled in collided with a train unexpectedly."},
{"id":88,"title":"Items on floor","text":"Items can be found on the bottom floor of the library."},
{"id":89,"title":"Meet requirement","text":"Students meet the minimum requirement qualified."},
{"id":90,"title":"Test showed","text":"The test showed that you know a lot about Canada."},
{"id":91,"title":"Computer lab open","text":"The computer lab is open 24 hours a day."},
{"id":92,"title":"Biotechnology is future","text":"The professor mentioned that biotechnology is the future of traditional biology."},
{"id":93,"title":"Submitted to office","text":"Assignments should be submitted to the department office before the deadline."},
{"id":94,"title":"Add a salad","text":"You can add a salad to your meal."},
{"id":95,"title":"Restricted scholarships","text":"Restricted scholarships target principally at the students with specific goals."},
{"id":96,"title":"Watch is fast","text":"I think your watch is fast, you need to reset it."},
{"id":97,"title":"Participate in exercise","text":"All students must participate in the exercise."},
{"id":98,"title":"Appointment with tutor","text":"Please make an appointment with your tutor about work after the holiday."},
{"id":99,"title":"Within the framework","text":"It's within the framework that we carry out our survey."},
{"id":100,"title":"Student discount cards","text":"Student discount cards can be used on campus at the coffee house."},
{"id":101,"title":"Support of lecturers","text":"The support and advice of lecturers within the department has been invaluable."},
{"id":102,"title":"Employees go around","text":"Employees go around the park at lunchtime."}
];

/* ========== UI references ========== */
const selectSection = document.getElementById('selectSection');
const selectQ = document.getElementById('selectQ');
const voiceSelect = document.getElementById('voiceSelect');
const repeatInput = document.getElementById('repeatInput');
const modeBtn = document.getElementById('modeBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const prevBtn = document.getElementById('prevBtn');
const startBtn = document.getElementById('startBtn');
const nextBtn = document.getElementById('nextBtn');
const paraMeta = document.getElementById('paraMeta');
const paraContent = document.getElementById('paraContent');
const statusEl = document.getElementById('status');

let state = {
  section: 'RA',
  idx: 0,
  chunks: [],
  chunkIndex: 0,
  playing: false,
  repeatTimes: 1,
  cyclePlayedCount: 0,
  stopRequested: false
};

/* ========== chunking & rendering =========
   Approach:
   - Keep U.S. etc protected when splitting
   - Split into "chunks" by slash or punctuation as earlier
   - For rendering, split chunk into words; wrap each word in .word (white-space:nowrap)
     and inside each .word create character .char spans (inline-block). This prevents
     breaking inside words while allowing per-character coloring.
*/
function buildChunksFromText(text) {
  // 暂时保护不应被分开的特殊结构
  let s = text
    .replace(/U\.S\./g, 'U_S_')          // U.S.
    .replace(/U\.K\./g, 'U_K_')          // U.K.
    .replace(/Mr\./g, 'Mr_')             // Mr.
    .replace(/Mrs\./g, 'Mrs_')           // Mrs.
    .replace(/Dr\./g, 'Dr_')             // Dr.
    .replace(/(\d):(\d{2})/g, '$1_COLON_$2') // 5:30 → 5_COLON_30
    .replace(/(\d)\.(\d)/g, '$1_DOT_$2');    // 3.14 → 3_DOT_14

  // 正常的分句符
  s = s.replace(/\s*\/\s*/g, ' |SLASH| ');
  s = s.replace(/([,!?;:—])/g, '$1|PUNC|');
  // 分句句号：忽略数字或缩写类情况
  s = s.replace(/(?<!\w\.\w\.)(?<!\d)\.(?!\d)/g, '.|PUNC|');

  // 恢复保护
  s = s
    .replace(/U_S_/g, 'U.S.')
    .replace(/U_K_/g, 'U.K.')
    .replace(/Mr_/g, 'Mr.')
    .replace(/Mrs_/g, 'Mrs.')
    .replace(/Dr_/g, 'Dr.')
    .replace(/_COLON_/g, ':')
    .replace(/_DOT_/g, '.');

  // 清理并分块
  s = s.replace(/\|SLASH\|/g, '|');
  s = s.replace(/\|PUNC\|/g, '|');
  const arr = s.split('|').map(p => p.trim()).filter(Boolean);
  return arr;
}

function renderPassage(section, index) {
  state.section = section;
  state.idx = index;
  state.chunkIndex = 0;
  state.cyclePlayedCount = 0;

  const p = (section === 'RA') ? raPassages[index] : rsPassages[index];
  if (!p) {
    paraMeta.textContent = 'No passage';
    paraContent.innerHTML = '';
    return;
  }

  paraMeta.textContent = `#${p.id} ${p.title}`;

  // RA 分意群；RS 整句一次性读
  let chunks;
  if (section === 'RA') {
    chunks = buildChunksFromText(p.text);
  } else {
    const whole = p.text.replace(/\s*\/\s*/g, ' ').trim();
    chunks = [whole];
  }
  state.chunks = chunks;

  // 重新渲染：保留空格字符
  paraContent.innerHTML = '';
  chunks.forEach((chunkText, ci) => {
    const chunkEl = document.createElement('span');
    chunkEl.dataset.ci = ci;
    for (let i = 0; i < chunkText.length; i++) {
      const ch = chunkText[i];
      if (ch === ' ') {
        // 直接添加真实空格
        chunkEl.appendChild(document.createTextNode(' '));
      } else {
        const chEl = document.createElement('span');
        chEl.className = 'char';
        chEl.dataset.ci = ci;
        chEl.dataset.charIndex = i;
        chEl.textContent = ch;
        chunkEl.appendChild(chEl);
      }
    }
    paraContent.appendChild(chunkEl);
    paraContent.appendChild(document.createTextNode(' ')); // 保持段落间距
  });

  highlightClearAll();
  updateStatus('idle');
}


/* helpers */
function highlightClearAll() {
  document.querySelectorAll('.char').forEach(c => c.classList.remove('colored'));
}
function colorWholeChunk(ci) {
  document.querySelectorAll(`.char[data-ci="${ci}"]`).forEach(c => c.classList.add('colored'));
}

/* animate characters for a specific chunk over duration (ms) */
function animateChars(ci, duration) {
  return new Promise(resolve => {
    const chars = Array.from(document.querySelectorAll(`.char[data-ci="${ci}"]`));
    if (chars.length === 0) { resolve(); return; }
    chars.forEach(c => c.classList.remove('colored'));
    const interval = Math.max(8, Math.round(duration / chars.length));
    let i = 0;
    const t = setInterval(() => {
      if (i >= chars.length) {
        clearInterval(t);
        // ensure all colored
        chars.forEach(c => c.classList.add('colored'));
        resolve();
        return;
      }
      chars[i].classList.add('colored');
      i++;
    }, interval);
  });
}

/* play one chunk: reads it using responsiveVoice, then during pause do the same-speed animate,
   hold until pause ends, then keep chunk colored.
*/
function playOneChunk(ci) {
  return new Promise(async (resolve) => {
    if (ci < 0 || ci >= state.chunks.length) { resolve(); return; }
    const chunkText = state.chunks[ci].trim();
    if (!chunkText) { resolve(); return; }
    const chars = Array.from(document.querySelectorAll(`.char[data-ci="${ci}"]`));
    if (chars.length === 0) { resolve(); return; }

    // estimate utterance duration: 200ms per word
    const wordCount = Math.max(1, chunkText.split(/\s+/).filter(Boolean).length);
    let estUtterDur = Math.max(160, Math.round(wordCount * 200));

    // during speak: approximate progressive highlight using estimate
    let animTimer = null;
    let animStart = performance.now();
    function startProgressiveDuringSpeak(durationEstimate) {
      animStart = performance.now();
      let lastIndex = -1;
      const charsLocal = chars;
      animTimer = setInterval(() => {
        const elapsed = performance.now() - animStart;
        const progress = Math.min(1, elapsed / durationEstimate);
        const targetIndex = Math.floor(progress * charsLocal.length) - 1;
        if (targetIndex > lastIndex) {
          for (let k = lastIndex+1; k <= targetIndex; k++) {
            if (charsLocal[k]) charsLocal[k].classList.add('colored');
          }
          lastIndex = targetIndex;
        }
        if (progress >= 1) {
          clearInterval(animTimer); animTimer = null;
        }
      }, 30);
    }

    // reset coloring for this chunk to initial black BEFORE speaking (for Repeat behavior)
    chars.forEach(c => c.classList.remove('colored'));

    updateStatus(`Speaking chunk ${ci+1} / ${state.chunks.length}`);

    // pick voice name from select; responsiveVoice supports names like 'UK English Male' etc
    const voiceName = voiceSelect.value || undefined;

    let utterStart = performance.now();
    try {
      // start approximate animation
      startProgressiveDuringSpeak(estUtterDur);

      responsiveVoice.speak(chunkText, voiceName, {
        rate: 1.0,
        onstart: function() {
          // refine start time
          utterStart = performance.now();
        },
        onend: async function() {
          const utterDur = Math.max(10, performance.now() - utterStart);
          // ensure we stop any estimate timer
          if (animTimer) { clearInterval(animTimer); animTimer = null; }
          // ensure fully colored at end of utterance
          chars.forEach(c => c.classList.add('colored'));

          const pauseMs = Math.round(utterDur * 1.5);

          // During pause: perform same left->right effect at same speed as reading:
          // remove colors then animate over utterDur, then hold remaining pause time, then keep colored.
          chars.forEach(c => c.classList.remove('colored'));
          await animateChars(ci, utterDur);
          const remaining = pauseMs - utterDur;
          if (remaining > 0) {
            await new Promise(r => setTimeout(r, remaining));
          }
          // keep colored after pause
          colorWholeChunk(ci);

          state.cyclePlayedCount++;
          resolve({utterDur, pauseMs});
        },
        onerror: function(e) {
          console.error('TTS error', e);
          if (animTimer) { clearInterval(animTimer); animTimer = null; }
          animateChars(ci, 800).then(()=>{ colorWholeChunk(ci); resolve({utterDur:800,pauseMs:1200}); });
        }
      });
    } catch (e) {
      console.error('Speak exception', e);
      if (animTimer) { clearInterval(animTimer); animTimer = null; }
      await animateChars(ci, 800);
      colorWholeChunk(ci);
      resolve({utterDur:800, pauseMs:1200});
    }
  });
}

/* ========== Sequence control ========== */
async function startPractice() {
  if (state.playing) return;
  state.stopRequested = false;
  state.playing = true;
  startBtn.textContent = '|| Pause';
  updateStatus('Playing');
  state.repeatTimes = Math.min(10, Math.max(1, parseInt(repeatInput.value || '1')));

  // RS: repeat whole sentence (i.e. all chunks in order) repeatTimes times,
  // then auto-advance to next question and auto-start that question.
  if (state.section === 'RS') {
    // Reset highlights before RS repeat
    highlightClearAll();

    for (let rep = 0; rep < state.repeatTimes; rep++) {
      if (!state.playing || state.stopRequested) break;
      // play each chunk sequentially
      for (let ci = 0; ci < state.chunks.length; ci++) {
        if (state.stopRequested) break;
        await playOneChunk(ci);
      }
      if (state.stopRequested) break;
    }

    // after finishing repeatTimes, auto-advance to next question and auto-start
    if (!state.stopRequested) {
      const sec = selectSection.value;
      const arr = (sec === 'RA') ? raPassages : rsPassages;
      if (!arr || arr.length === 0) {
        state.playing = false;
        startBtn.textContent = '▶ Start';
        updateStatus('Paused');
        return;
      }
      if (modeBtn.textContent === 'Random Mode') {
        const r = Math.floor(Math.random() * arr.length);
        selectQ.value = r;
        renderPassage(sec, r);
      } else {
        const newIdx = (state.idx + 1) % arr.length;
        selectQ.value = newIdx;
        renderPassage(sec, newIdx);
      }
      // small delay then auto-start next
      if (!state.stopRequested) {
        await new Promise(r => setTimeout(r, 200));
        state.playing = false; // ✅ 关键：重置播放状态，允许重新进入 startPractice()
        // recursive - will set playing true again
        startPractice();
        return;
      }
    }

    // finished or stopped
    state.playing = false;
    startBtn.textContent = '▶ Start';
    updateStatus('Paused');
    return;
  }

  // RA mode: chunk-by-chunk with repeatTimes per chunk
  while (state.playing && !state.stopRequested) {
    // ensure chunk index valid
    if (state.chunkIndex >= state.chunks.length) {
      state.chunkIndex = 0;
      highlightClearAll();
      state.cyclePlayedCount = 0;
    }
    for (let r = 0; r < state.repeatTimes; r++) {
      if (!state.playing || state.stopRequested) break;
      await playOneChunk(state.chunkIndex);
    }
    if (state.stopRequested || !state.playing) break;
    state.chunkIndex++;
    if (state.chunkIndex >= state.chunks.length) {
      // paragraph finished -> loop back to start (clearing highlights)
      await new Promise(r => setTimeout(r, 120));
      highlightClearAll();
      state.cyclePlayedCount = 0;
      state.chunkIndex = 0;
    }
  }

  state.playing = false;
  startBtn.textContent = '▶ Start';
  updateStatus('Paused');
}

function pausePractice() {
  state.stopRequested = true;
  state.playing = false;
  try { responsiveVoice.cancel(); } catch(e){}
  startBtn.textContent = '▶ Start';
  updateStatus('Paused');
}

/* ========== UI wiring ========== */
function populateSections() {
  selectSection.innerHTML = '';
  const o1 = document.createElement('option'); o1.value = 'RA'; o1.textContent = 'Read Aloud'; selectSection.appendChild(o1);
  const o2 = document.createElement('option'); o2.value = 'RS'; o2.textContent = 'Repeat Sentence'; selectSection.appendChild(o2);
}
function populateQuestionsForSection(section) {
  selectQ.innerHTML = '';
  const arr = (section === 'RA') ? raPassages : rsPassages;
  if (!arr || arr.length === 0) {
    const opt = document.createElement('option'); opt.value = -1; opt.textContent = '(No questions)'; selectQ.appendChild(opt); return;
  }
  arr.forEach((p,i) => {
    const opt = document.createElement('option'); opt.value = i; opt.textContent = `#${p.id} ${p.title}`; selectQ.appendChild(opt);
  });
}

selectSection.addEventListener('change', (e) => {
  const sec = e.target.value;
  populateQuestionsForSection(sec);
  selectQ.value = 0;
  renderPassage(sec, 0);
});

selectQ.addEventListener('change', (e) => {
  const i = Number(e.target.value);
  const sec = selectSection.value;
  renderPassage(sec, i);
  // do NOT auto-start on manual dropdown change to avoid unexpected autoplay.
});

modeBtn.addEventListener('click', () => {
  if (modeBtn.textContent === 'Custom Mode') { modeBtn.textContent = 'Random Mode'; } else { modeBtn.textContent = 'Custom Mode'; }
  const isRandom = (modeBtn.textContent === 'Random Mode');
  selectQ.disabled = isRandom;
  if (isRandom) {
    const sec = selectSection.value; const arr = (sec === 'RA') ? raPassages : rsPassages;
    if (arr && arr.length) { const r = Math.floor(Math.random() * arr.length); selectQ.value = r; renderPassage(sec, r); }
  }
});

prevBtn.addEventListener('click', () => {
  const sec = selectSection.value;
  const arr = (sec === 'RA') ? raPassages : rsPassages;
  if (!arr || arr.length === 0) return;
  let newIdx;
  if (modeBtn.textContent === 'Random Mode') {
    const r = Math.floor(Math.random() * arr.length); newIdx = r;
  } else {
    newIdx = (state.idx - 1 + arr.length) % arr.length;
  }
  // stop current
  pausePractice();
  selectQ.value = newIdx;
  renderPassage(sec, newIdx);
  // automatically start playback after navigation
  setTimeout(() => { startPractice(); }, 180);
});

nextBtn.addEventListener('click', () => {
  const sec = selectSection.value;
  const arr = (sec === 'RA') ? raPassages : rsPassages;
  if (!arr || arr.length === 0) return;
  let newIdx;
  if (modeBtn.textContent === 'Random Mode') {
    const r = Math.floor(Math.random() * arr.length); newIdx = r;
  } else {
    newIdx = (state.idx + 1) % arr.length;
  }
  pausePractice();
  selectQ.value = newIdx;
  renderPassage(sec, newIdx);
  setTimeout(() => { startPractice(); }, 180);
});

startBtn.addEventListener('click', () => {
  if (state.playing) {
    pausePractice();
  } else {
    state.repeatTimes = Math.min(10, Math.max(1, Number(document.getElementById('repeatInput').value) || 1));
    state.stopRequested = false;
    const sec = selectSection.value;
    const arr = (sec === 'RA') ? raPassages : rsPassages;
    if (!arr || arr.length === 0) { updateStatus('No question to play'); return; }
    startPractice();
  }
});

fullscreenBtn.addEventListener('click', () => {
  try {
    if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); }
  } catch (e) { console.error('Fullscreen error', e); updateStatus('Fullscreen not available'); }
});
document.addEventListener('fullscreenchange', () => { fullscreenBtn.textContent = document.fullscreenElement ? 'Exit Full Screen' : 'Enter Full Screen'; });

/* ========== utilities ========== */
function updateStatus(txt) { statusEl.textContent = `Status: ${txt}`; }

/* ========== init ========== */
(function init() {
  populateSections();
  selectSection.value = 'RA';
  populateQuestionsForSection('RA');
  if (raPassages.length > 0) { selectQ.value = 0; renderPassage('RA',0); }
  updateStatus('Ready');
})();
</script>
</body>
</html>
